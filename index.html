<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ball game</title>
    <style>
        header {
            display: flex;
        }
        header div {
            flex: 1;
            padding: 20px;
        }
        section {
            display: flex;
            justify-content: center;
            margin: 20px 0 0;
        }
        main {
            width: 300px;
            height: 500px;
            border: 1px solid #000;
            background: #00a86b;
            position: relative;
        }
        main div {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        main .start {
            background: #aaa;
        }
        main .hole {
            background: #000;
        }
        main .ball {
            background: #fff;
        }
        aside {
            width: 200px;
            margin-left: 20px;
        }
        aside button {
            display: block;
            width: 100%;
            padding: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="power">Power: 0</div>
        <div class="angle">Angle: 0</div>
        <div class="score">Score: 999</div>
    </header>
    <section>
        <main>
            <div class="start"></div>
            <div class="ball"></div>
            <div class="hole"></div>
        </main>
        <aside>
            <button id="btnShootRandom">Shoot Random</button>
            <button id="btnTrain">Train</button>
            <button id="btnStopTrain">Stop Training</button>
            <button id="btnShootToWin">Shoot To Win</button>
        </aside>
    </section>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/synaptic/1.1.4/synaptic.js"></script>
    <script>
        let score, angle, power, powerTick
        const start = document.querySelector('.start')
        const ball = document.querySelector('.ball')
        const hole = document.querySelector('.hole')
        let callback = null
        const network = new synaptic.Architect.Perceptron(4, 16, 16, 2)
        let flagStopTraining = false
        let trainCount = 0

        const startx = 150
        const starty = 480
        const holex = 150
        const holey = 80

        start.style.left = startx + 'px'
        start.style.top = starty + 'px'
        hole.style.left = holex + 'px'
        hole.style.top = holey + 'px'

        reset();
        document.getElementById('btnShootRandom').onclick = function() { shootRandom() }
        document.getElementById('btnTrain').onclick = function() { learn() }
        document.getElementById('btnStopTrain').onclick = function() { stopTraining() }
        document.getElementById('btnShootToWin').onclick = function() { shootToWin() }

        function shootRandom(pCallback) {
            rndAngle = randomBetween(0, 2 * Math.PI)
            rndPower = randomBetween(0, 100)
            shoot(rndAngle, rndPower, pCallback)
        }

        function shoot(pAngle, pPower, pCallback) {
            reset()
            setAngle(pAngle)
            setPower(pPower)
            callback = pCallback || null

            console.log('Shooting. Power: ' + power + ' Angle: ' + angle)

            requestAnimationFrame(tick)
        }

        function moveBall({ x: x, y: y }) {
            ball.style.left = x + 'px'
            ball.style.top = y + 'px'
        }

        function reset() {
            angle = 0
            power = 0
            moveBall(getPosition(start))
        }

        function getPosition(el) {
            return { x: el.offsetLeft, y: el.offsetTop }
        }

        function tick() {
            const pos = getPosition(ball)
            pos.x += Math.cos(angle) * powerTick * 0.1
            pos.y += Math.sin(angle) * powerTick * 0.1
            moveBall(pos)
            powerTick -= 1;
            if (powerTick <= 0 || isOutOfBounds()) {
                powerTick = 0
                return endGo();
            }
            requestAnimationFrame(tick)
        }

        function randomBetween(a, b) {
            return Math.random() * (b - a) + a;
        }

        function setAngle(p) {
            angle = p
            document.querySelector('.angle').textContent = 'Angle: ' + (Math.round(angle*100)/100)
        }

        function setPower(p) {
            power = p
            powerTick = power
            document.querySelector('.power').textContent = 'Power: ' + Math.round(power)
        }

        function calculateScore() {
            if (isOutOfBounds()) {
                score = 999
            } else {
                score = distanceBetween(getPosition(ball), getPosition(hole))
            }
            document.querySelector('.score').textContent = 'Score: ' + Math.round(score)
        }

        function endGo() {
            calculateScore()
            if (callback) {
                callback()
            }
        }

        function endless() {
            shootRandom(endless)
        }

        function isOutOfBounds() {
            const pos = getPosition(ball)
            if (
                pos.x < 0 ||
                pos.x > 300 ||
                pos.y < 0 ||
                pos.y > 500
            ) {
                return true
            }
            return false
        }

        function distanceBetween(ball, hole) {
            const dx = Math.pow(Math.abs(ball.x - hole.x), 2)
            const dy = Math.pow(Math.abs(ball.y - hole.y), 2)
            return Math.sqrt(dx + dy)
        }

        function learn() {
            learnTrain(_ => {
                console.log('Finished training. Train count: ' + trainCount)
            })

            function learnTrain(callback) {
                if (flagStopTraining) {
                    flagStopTraining = false
                    if (callback) {
                        callback()
                    }
                    return
                }

                shootRandom(_ => {
                    const ballPos = getPosition(ball)
                    if (!isOutOfBounds()) {
                        network.activate([
                            normaliseX(startx),
                            normaliseY(starty),
                            normaliseX(ballPos.x),
                            normaliseY(ballPos.y)
                        ])
                        network.propagate(.3, [
                            normaliseAngle(angle),
                            normalisePower(power)
                        ])
                        trainCount++
                    }
                    learnTrain(callback)
                })
            }
        }

        function stopTraining() {
            flagStopTraining = true
        }

        function shootToWin() {
            const output = network.activate([
                normaliseX(startx),
                normaliseY(starty),
                normaliseX(holex),
                normaliseY(holey)
            ])
            shoot(
                denormaliseAngle(output[0]),
                denormalisePower(output[1])
            )
        }

        function disableButtons() {
            const buttons = document.querySelectorAll('button')
            for (var i in buttons) {
                buttons[i].disabled = true
            }
        }

        function enableButtons() {
            const buttons = document.querySelectorAll('button')
            for (var i in buttons) {
                buttons[i].disabled = false
            }
        }

        function normalise(value, min, max) {
            return Math.min(Math.max((value - min) / (max - min), 0), 1)
        }

        function denormalise(value, min, max) {
            return (value * (max - min)) + min
        }

        function normaliseAngle(value) {
            return normalise(value, 0, 2 * Math.PI)
        }

        function denormaliseAngle(value) {
            return denormalise(value, 0, 2 * Math.PI)
        }

        function normalisePower(value) {
            return normalise(value, 0, 100)
        }

        function denormalisePower(value) {
            return denormalise(value, 0, 100)
        }

        function normaliseX(value) {
            return normalise(value, 0, 300)
        }

        function denormaliseX(value) {
            return denormalise(value, 0, 300)
        }

        function normaliseY(value) {
            return normalise(value, 0, 500)
        }

        function denormaliseY(value) {
            return denormalise(value, 0, 500)
        }

    </script>
</body>
</html>